!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Passwordless={})}(this,(function(e){"use strict";class t{config={apiUrl:"https://api.passwordless.dev/",apiKey:"",Origin:location.origin,RPID:location.hostname};constructor(e){this.config={...this.config,...e}}static async isEnabledOnDevice(){return await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable()}static isSupportedByBrowser(){return void 0!==window.PublicKeyCredential&&"function"==typeof window.PublicKeyCredential}CheckSupport(){if(!t.isSupportedByBrowser())throw new Error("WebAuthn and PublicKeyCredentials are not supported on this browser/device")}async register(e){let t,r,i;this.CheckSupport();try{var{data:n,sessionId:a}=await this.registerBegin(e);t=n,r=a}catch(e){throw console.error("Failed during register/begin"),e}t.challenge=coerceToArrayBuffer(t.challenge),t.user.id=coerceToArrayBuffer(t.user.id),t.excludeCredentials=t.excludeCredentials.map(e=>(e.id=coerceToArrayBuffer(e.id),e)),null===t.authenticatorSelection.authenticatorAttachment&&(t.authenticatorSelection.authenticatorAttachment=void 0);try{i=await navigator.credentials.create({publicKey:t})}catch(e){throw console.warn("Failed during credentials.create in browser. One reason could be because the username is already registered with your authenticator. Please change username or authenticator.",e),e}try{await this.registerComplete(i,r)}catch(e){console.warn("Failed during register/complete",e)}}async registerBegin(e){const t=await fetch(this.config.apiUrl+"register/begin",{method:"POST",body:JSON.stringify({token:e,...this._params()}),headers:{Accept:"application/json","Content-Type":"application/json",ApiKey:this.config.apiKey}});return await t.json()}async registerComplete(e,t){let r=new Uint8Array(e.response.attestationObject),i=new Uint8Array(e.response.clientDataJSON),n=new Uint8Array(e.rawId);const a={id:e.id,rawId:coerceToBase64Url(n),type:e.type,extensions:e.getClientExtensionResults(),response:{AttestationObject:coerceToBase64Url(r),clientDataJson:coerceToBase64Url(i)}},o=await fetch(this.config.apiUrl+"register/complete",{method:"POST",body:JSON.stringify({response:a,sessionId:t,sessionId:t,...this._params()}),headers:{Accept:"application/json","Content-Type":"application/json",ApiKey:this.config.apiKey}});return await o.json()}async signin(e){var t,r;this.CheckSupport();try{({data:t,sessionId:r}=await this.signinBegin(e))}catch(e){throw console.warn("Failed during signin/begin",e),e}let i;t.challenge=coerceToArrayBuffer(t.challenge),t.allowCredentials.forEach((function(e){e.id=coerceToArrayBuffer(e.id)}));try{i=await navigator.credentials.get({publicKey:t})}catch(e){throw console.warn("Failed during credentials.get in browser.",e),e}try{return(await this.signinComplete(i,r)).data}catch(e){throw console.warn("Failed during signin/complete",e),e}}async signinBegin(e){var t=await fetch(this.config.apiUrl+"signin/begin",{method:"POST",body:JSON.stringify({username:e,...this._params()}),headers:{Accept:"application/json",ApiKey:this.config.apiKey}});return await t.json()}async signinComplete(e,t){let r=new Uint8Array(e.response.authenticatorData),i=new Uint8Array(e.response.clientDataJSON),n=new Uint8Array(e.rawId),a=new Uint8Array(e.response.signature);const o={id:e.id,rawId:coerceToBase64Url(n),type:e.type,extensions:e.getClientExtensionResults(),response:{authenticatorData:coerceToBase64Url(r),clientDataJson:coerceToBase64Url(i),signature:coerceToBase64Url(a)}};var s=await fetch(this.config.apiUrl+"signin/complete",{method:"POST",body:JSON.stringify({response:o,sessionId:t,...this._params()}),headers:{Accept:"application/json",ApiKey:this.config.apiKey}});return await s.json()}_params(){return{RPID:this.config.RPID,Origin:this.config.Origin}}}coerceToArrayBuffer=function(e){if("string"==typeof e){e=e.replace(/-/g,"+").replace(/_/g,"/");for(var t=window.atob(e),r=new Uint8Array(t.length),i=0;i<t.length;i++)r[i]=t.charCodeAt(i);e=r}if(Array.isArray(e)&&(e=new Uint8Array(e)),e instanceof Uint8Array&&(e=e.buffer),!(e instanceof ArrayBuffer))throw new TypeError("could not coerce to ArrayBuffer");return e},coerceToBase64Url=function(e){if(Array.isArray(e)&&(e=Uint8Array.from(e)),e instanceof ArrayBuffer&&(e=new Uint8Array(e)),e instanceof Uint8Array){for(var t="",r=e.byteLength,i=0;i<r;i++)t+=String.fromCharCode(e[i]);e=window.btoa(t)}if("string"!=typeof e)throw new Error("could not coerce to string");return e=e.replace(/\+/g,"-").replace(/\//g,"_").replace(/=*$/g,"")},e.PasswordlessClient=t,Object.defineProperty(e,"__esModule",{value:!0})}));
